name: Dependabot â€” block PRs with fixable alerts
on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

permissions:
  contents: read
  security-events: read

jobs:
  check-fixable-dependabot-alerts:
    name: Check Dependabot fixable alerts
    runs-on: ubuntu-latest
    steps:
      - name: Foobar
        run: echo ${{ secrets.GITHUB_TOKEN }} ${{ github.repository }}
      - name: Ensure gh and jq are available
        run: |
          echo "gh version: $(gh --version | head -n1)"
          echo "jq version: $(jq --version)"
      - name: Query Dependabot alerts and fail if any are fixable
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail
          echo "Fetching open Dependabot alerts for $OWNER $REPO ..."
          # Use gh to paginate through alerts; output one JSON object per line
          gh api --paginate "repos/$REPO/dependabot/alerts?state=open" -H "Accept: application/vnd.github+json" --jq '.[]' > /tmp/all_alerts.json || true

          # If there are no alerts at all, the file will be empty or absent
          if [ ! -s /tmp/all_alerts.json ]; then
            echo "No open Dependabot alerts."
            exit 0
          fi

          # Select alerts that have at least one vulnerability with a first_patched_version (i.e. a known fix)
          fixable_count=$(jq -s 'map(select(any(.security_advisory.vulnerabilities[]?; .first_patched_version != null))) | length' /tmp/all_alerts.json)

          if [ "$fixable_count" -gt 0 ]; then
            echo "::error ::Found ${fixable_count} fixable Dependabot alert(s). Listing them:"
            jq -s 'map(select(any(.security_advisory.vulnerabilities[]?; .first_patched_version != null))) | .[] | "- \(.dependency.package.name) (\(.dependency.package.ecosystem)) severity:\(.security_advisory.severity) \(.html_url)"' /tmp/all_alerts.json
            # Emit a failure so the check is red on the PR
            exit 1
          else
            echo "No fixable Dependabot alerts found."
          fi