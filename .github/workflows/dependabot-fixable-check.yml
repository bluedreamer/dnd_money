name: ci
on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

permissions:
  contents: read

jobs:
  check-fixable-dependabot-alerts-for-pr:
    name: Check Dependabot fixable alerts
    runs-on: ubuntu-latest
    env:
      REPO: ${{ github.repository }}
      PR_NUMBER: ${{ github.event.pull_request.number }}
      GH_TOKEN: ${{ secrets.DEP_AUDIT_TOKEN }}
    steps:
      - name: Prepare runner
        run: |
          set -euo pipefail
          echo "Repo: $REPO PR: $PR_NUMBER"
          gh --version || true
          jq --version || true

      - name: Fetch open Dependabot alerts
        id: fetch_alerts
        run: |
          set -euo pipefail

          OUT=/tmp/all_alerts.json
          echo "Fetching open Dependabot alerts for $REPO ..."
          gh api --paginate "repos/$REPO/dependabot/alerts?state=open&per_page=100" -H "Accept: application/vnd.github+json" --jq '.[]' > "$OUT" || true

          if [ ! -s "$OUT" ]; then
            echo "No open Dependabot alerts returned by the API."
            jq -n '[]' > /tmp/alerts_normalized.json
            echo "::set-output name=alerts_file::/tmp/alerts_normalized.json"
            exit 0
          fi

          # Normalize into a JSON array with the fields we need
          jq -s 'map({
              id: (.number // .id // 0),
              package: (.dependency.package.name // "unknown"),
              ecosystem: (.dependency.package.ecosystem // "unknown"),
              url: (.html_url // "unknown"),
              patched_versions: ([.security_advisory.vulnerabilities[]? | .first_patched_version] | map(select(.!=null)) | unique)
            })' "$OUT" > /tmp/alerts_normalized.json

          echo "::set-output name=alerts_file::/tmp/alerts_normalized.json"

      - name: Fetch PR file patches
        id: fetch_pr_files
        run: |
          set -euo pipefail

          echo "Fetching changed files for PR #$PR_NUMBER ..."
          gh api --paginate "repos/$REPO/pulls/$PR_NUMBER/files?per_page=100" -H "Accept: application/vnd.github+json" --jq '.[]' > /tmp/pr_files_raw.json || true

          # Create a compact JSON array with filename + patch (patch may be absent for binary files)
          jq -s 'map({filename: .filename, patch: (.patch // "")})' /tmp/pr_files_raw.json > /tmp/pr_files.json

          echo "::set-output name=pr_files::/tmp/pr_files.json"

      - name: Compare alerts vs PR changes and fail if any remain
        run: |
          set -euo pipefail
          ALERTS_FILE=/tmp/alerts_normalized.json
          PR_FILES=/tmp/pr_files.json

          if [ ! -s "$ALERTS_FILE" ] || [ "$(jq 'length' "$ALERTS_FILE")" -eq 0 ]; then
            echo "No Dependabot alerts to evaluate. Passing."
            exit 0
          fi

          # Gather all added lines from PR patches
          jq -r '.[] | .patch' "$PR_FILES" > /tmp/all_patches_raw.txt || true
          awk '/^\+[^+]/ { print substr($0,2) }' /tmp/all_patches_raw.txt > /tmp/pr_added_lines.txt || true

          # Use jq --slurpfile to read alerts and added lines robustly (portable)
          jq -n --slurpfile alerts "$ALERTS_FILE" --slurpfile added /tmp/pr_added_lines.txt '
            def added_lines: ($added[0] // "") | split("\n");
            ($alerts[0]
              | map(
                  select(.patched_versions | length > 0)
                  | . as $a
                  | ($a.patched_versions
                      | any( . as $pv
                          | (added_lines[]? | index($pv) ) )
                    ) as $addressed
                  | if $addressed then empty else $a end
                )
            )' > /tmp/remaining_alerts.json

          rem_count=$(jq 'length' /tmp/remaining_alerts.json || echo 0)
          if [ "$rem_count" -gt 0 ]; then
            echo "::error ::Found ${rem_count} fixable Dependabot alert(s) NOT addressed by this PR. Listing them:"
            jq -r '.[] | "- id: \(.id) package: \(.package) ecosystem: \(.ecosystem) patched_versions: \(.patched_versions | join(", ")) url: \(.url)"' /tmp/remaining_alerts.json
            exit 1
          else
            echo "All fixable Dependabot alerts are either not present or are addressed by this PR. Passing."
            exit 0
          fi